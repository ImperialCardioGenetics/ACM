---
title: "genoPheno"
author: "james ware & risha govind"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(lazyeval)
library(dplyr)
library(pander)
library(gdata)
require(gdata)
```

```{r load data}

BRUID_localID <- read.csv("../BRUID_localID.csv", header=T, sep=',') %>%
  tbl_df

ACM_geno <- read.csv("../Samples_pathogenics_variants.csv", header=T, sep=',') %>%
  tbl_df

ACM_pheno = read.xls("../ACM_pheno.xlsx", sheet=1, header=T, fileEncoding="latin1") 

ACM_english_headers = read.csv ("../ACM_ColumnNames_English.csv", header = FALSE, sep=',', fileEncoding="latin1")

dim(ACM_pheno)
```


```{r removing empty rows and columns from excel file df}

#remove blank columns
ACM_pheno <- ACM_pheno[,colSums(is.na(ACM_pheno))<nrow(ACM_pheno)]
#remove rows that do not have sampleIDs
ACM_pheno <- ACM_pheno[!(ACM_pheno$SAMPLES  == ""), ]  %>%
  tbl_df

dim(ACM_pheno)


```

```{r update spanish col names to english in ACM_pheno}

ACM_pheno_colNames = colnames(ACM_pheno)

count <- nrow(ACM_english_headers)

for (i in 1:count){
  headerSpanish <- ACM_english_headers$V1[i]
  headerEnglish <- ACM_english_headers$V2[i]
  ACM_pheno_colNames<-gsub(headerSpanish, headerEnglish, ACM_pheno_colNames,ignore.case = TRUE)
  headerSpanish<- gsub(x = headerSpanish,replacement = "\\.", pattern = " ")
  ACM_pheno_colNames<-gsub(headerSpanish, headerEnglish, ACM_pheno_colNames,ignore.case = TRUE)
  headerSpanish<- gsub(x = headerSpanish,replacement = "_", pattern = " ")
  ACM_pheno_colNames<-gsub(headerSpanish, headerEnglish, ACM_pheno_colNames,ignore.case = TRUE)
  headerSpanish<- gsub(x = headerSpanish,replacement = "DEATH", pattern = "MUERTE")
  ACM_pheno_colNames<-gsub(headerSpanish, headerEnglish, ACM_pheno_colNames,ignore.case = TRUE)  
}

#manual assignments, not in the coversion table or were not comparable due to typos
ACM_pheno_colNames<-gsub("Fecha.DEATH", "DATE OF DEATH", ACM_pheno_colNames,ignore.case = TRUE)
ACM_pheno_colNames<-gsub("Fecha.TRANSPLANT","DATE OF TRANSPLANT", ACM_pheno_colNames,ignore.case = TRUE)
ACM_pheno_colNames<-gsub("EDAD.UltC","AGE AT LAST CONSULTATION", ACM_pheno_colNames,ignore.case = TRUE)
ACM_pheno_colNames<-gsub("Causa_MUER","CAUSE OF DEATH", ACM_pheno_colNames,ignore.case = TRUE)
ACM_pheno_colNames<-gsub("FECHA_NACMIENTO","BIRTHDATE", ACM_pheno_colNames,ignore.case = TRUE)
ACM_pheno_colNames<-gsub("RITHM.","RYTHM", ACM_pheno_colNames,ignore.case = TRUE)
ACM_pheno_colNames<-gsub("BETABLOQ","BETABLOCKER", ACM_pheno_colNames,ignore.case = TRUE)
ACM_pheno_colNames<-gsub("BebeActual","CURRENT DRINKER", ACM_pheno_colNames,ignore.case = TRUE)
ACM_pheno_colNames<-gsub("INITIAL EYECTION FRACTION","INITIAL EJECTION FRACTION", ACM_pheno_colNames,ignore.case = TRUE)
#DATE_ONSET_OF_SYNTOMS

#Fix errors introduced from the for loop ... Might need to fix that code
ACM_pheno_colNames<-gsub("BILIRUBINUBINUBINUBIN","BILIRUBIN", ACM_pheno_colNames,ignore.case = TRUE)
ACM_pheno_colNames<-gsub("AMIODARONERONERONERONE","AMIODARONE", ACM_pheno_colNames,ignore.case = TRUE)
ACM_pheno_colNames<-gsub("QRS DURATION DURATION DURATION DURATION.120","QRS_gt_120", ACM_pheno_colNames,ignore.case = TRUE)
ACM_pheno_colNames<-gsub("QRS DURATION DURATION DURATION DURATION","QRS DURATION", ACM_pheno_colNames,ignore.case = TRUE)


ACM_pheno_colNames<-gsub(" ","_", ACM_pheno_colNames,ignore.case = TRUE)
ACM_pheno_colNames<-gsub("\\.","_", ACM_pheno_colNames,ignore.case = TRUE)

#add column names to ACM_pheno
colnames(ACM_pheno)<- ACM_pheno_colNames

```


```{r combine data}


  
#remove irrelevant columns 
BRUID_localID <-BRUID_localID[,c("LocalIdNumber","BruNumber")]

#update the LocalIdNumber of one sample was does not match with the pheno file 
BRUID_localID$LocalIdNumber <- as.character(BRUID_localID$LocalIdNumber)
BRUID_localID$LocalIdNumber[BRUID_localID$LocalIdNumber == 'BELL-508 BIS'] <- "BELL-508"

#Add BRU IDs to pheno table
ACM_pheno_BRUID<-merge(BRUID_localID, ACM_pheno, by.x = "LocalIdNumber", by.y = "SAMPLES", all = TRUE) %>%
  tbl_df

#remove filtered data  
ACM_geno <- ACM_geno[(ACM_geno$Include  == "Yes"), ]

#remove irrelevant columns 
ACM_geno <-ACM_geno[,c("GENE","BRUID")]

ACM <- merge(ACM_geno, ACM_pheno_BRUID, by.x = "BRUID", by.y = "BruNumber", all = TRUE) %>%
  tbl_df

#replace na values in GENE column 
ACM$GENE <- as.character(ACM$GENE)
ACM$GENE[is.na(ACM$GENE)] <- "genotype_negative"

dim(ACM)

```



## data summary table
```{r summarise acm phenotype by genotype}

ACM %>%
  #exclude samples with other_dcm_mutations, unless they are TTN pos
  filter(GENE=="TTN" | GENE=="genotype_negative") %>% 
group_by(GENE) %>%
  summarise(
    initialLVEF = mean(INITIAL_EJECTION_FRACTION,na.rm=T),
    ageAtinitialAssesement = mean(AGE_AT_INICIAL_CLINICAL_ASSESSMENT,na.rm=T)
    ) %>%
  t %>% #transposes if you like that way...
  pander
```

I had to do `na.rm=T` here, because there was some missing data. Need to check if this appropriate.

## stats
```{r}
ACM %>%
  filter(GENE=="TTN" | GENE=="genotype_negative") %>%
  with(.,t.test(INITIAL_EJECTION_FRACTION ~ GENE))
```

```{r}
ACM %>%
  filter(GENE=="TTN" | GENE=="genotype_negative") %>%
  summarise(
    lvef_pValue=with(.,t.test(INITIAL_EJECTION_FRACTION ~ GENE)$p.val),
    age_pValue=with(.,t.test(AGE_AT_INICIAL_CLINICAL_ASSESSMENT ~ GENE)$p.val)
  )
  
```



Actually - looking at the output of the t.test, you could just get the means of the two group from there.  Or use the summary method above.

