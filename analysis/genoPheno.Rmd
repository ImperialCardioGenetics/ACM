---
title: "genoPheno"
author: "james ware & risha govind"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(lazyeval)
library(dplyr)
library(pander)
library(gdata)
require(gdata)
```

## Load datasets
```{r load data}

#BRUID to Spanish IDS [From Rachel]
BRUID_localID <- read.csv("../BRUID_localID.csv", header=T, sep=',') %>%
  tbl_df

#Genotypes of ACM Samples [From Liz]
ACM_geno <- read.csv("../Samples_pathogenics_variants.csv", header=T, sep=',') %>%
  tbl_df

#Clinical Phenotype of ACM Samples [From Spanish Team]
ACM_pheno = read.xls("../ACM_pheno.xlsx", sheet=1, header=T, fileEncoding="latin1") 

#English translations of headers of ACM_pheno file [From Spanish Team]
ACM_english_headers = read.csv ("../ACM_ColumnNames_English.csv", header = FALSE, sep=',', fileEncoding="latin1")

dim(ACM_pheno)
```

## removing blank rows/columns from excel file dataframe
```{r removing empty rows and columns from excel file dataframe}

#remove blank columns
ACM_pheno <- ACM_pheno[,colSums(is.na(ACM_pheno))<nrow(ACM_pheno)]
#remove rows that do not have sampleIDs
ACM_pheno <- ACM_pheno[!(ACM_pheno$SAMPLES  == ""), ]  %>%
  tbl_df

dim(ACM_pheno)


```

## Update Headers to English 
```{r update spanish col names to english in ACM_pheno}

ACM_pheno_colNames = colnames(ACM_pheno)

count <- nrow(ACM_english_headers)

for (i in 1:count){
  headerSpanish <- ACM_english_headers$V1[i]
  headerEnglish <- ACM_english_headers$V2[i]
  ACM_pheno_colNames<-gsub(headerSpanish, headerEnglish, ACM_pheno_colNames,ignore.case = TRUE)
  headerSpanish<- gsub(x = headerSpanish,replacement = "\\.", pattern = " ")
  ACM_pheno_colNames<-gsub(headerSpanish, headerEnglish, ACM_pheno_colNames,ignore.case = TRUE)
  headerSpanish<- gsub(x = headerSpanish,replacement = "_", pattern = " ")
  ACM_pheno_colNames<-gsub(headerSpanish, headerEnglish, ACM_pheno_colNames,ignore.case = TRUE)
  headerSpanish<- gsub(x = headerSpanish,replacement = "DEATH", pattern = "MUERTE")
  ACM_pheno_colNames<-gsub(headerSpanish, headerEnglish, ACM_pheno_colNames,ignore.case = TRUE)  
}

#manual assignments, not in the coversion table or were not comparable due to typos
ACM_pheno_colNames<-gsub("Fecha.DEATH", "DATE OF DEATH", ACM_pheno_colNames,ignore.case = TRUE)
ACM_pheno_colNames<-gsub("Fecha.TRANSPLANT","DATE OF TRANSPLANT", ACM_pheno_colNames,ignore.case = TRUE)
ACM_pheno_colNames<-gsub("EDAD.UltC","AGE AT LAST CONSULTATION", ACM_pheno_colNames,ignore.case = TRUE)
ACM_pheno_colNames<-gsub("Causa_MUER","CAUSE OF DEATH", ACM_pheno_colNames,ignore.case = TRUE)
ACM_pheno_colNames<-gsub("FECHA_NACMIENTO","BIRTHDATE", ACM_pheno_colNames,ignore.case = TRUE)
ACM_pheno_colNames<-gsub("RITHM.","RHYTHM", ACM_pheno_colNames,ignore.case = TRUE)
ACM_pheno_colNames<-gsub("BETABLOQ","BETABLOCKER", ACM_pheno_colNames,ignore.case = TRUE)
ACM_pheno_colNames<-gsub("BebeActual","CURRENT DRINKER", ACM_pheno_colNames,ignore.case = TRUE)
ACM_pheno_colNames<-gsub("INITIAL EYECTION FRACTION","INITIAL EJECTION FRACTION", ACM_pheno_colNames,ignore.case = TRUE)
ACM_pheno_colNames<-gsub("DATE ONSET OF SYNTOMS","DATE ONSET OF SYMPTOMS", ACM_pheno_colNames,ignore.case = TRUE)
ACM_pheno_colNames<-gsub("AGE AT INICIAL CLINICAL ASSESSMENT","AGE AT INITIAL CLINICAL ASSESSMENT", ACM_pheno_colNames,ignore.case = TRUE)

#Fix errors introduced from the for loop ... Might need to fix that code
ACM_pheno_colNames<-gsub("BILIRUBINUBINUBINUBIN","BILIRUBIN", ACM_pheno_colNames,ignore.case = TRUE)
ACM_pheno_colNames<-gsub("AMIODARONERONERONERONE","AMIODARONE", ACM_pheno_colNames,ignore.case = TRUE)
ACM_pheno_colNames<-gsub("QRS DURATION DURATION DURATION DURATION.120","QRS_gt_120", ACM_pheno_colNames,ignore.case = TRUE)
ACM_pheno_colNames<-gsub("QRS DURATION DURATION DURATION DURATION","QRS DURATION", ACM_pheno_colNames,ignore.case = TRUE)


ACM_pheno_colNames<-gsub(" ","_", ACM_pheno_colNames,ignore.case = TRUE)
ACM_pheno_colNames<-gsub("\\.","_", ACM_pheno_colNames,ignore.case = TRUE)

#add column names to ACM_pheno
colnames(ACM_pheno)<- ACM_pheno_colNames

```

## Combine all datasets
```{r combine data}

#remove irrelevant columns 
BRUID_localID <-BRUID_localID[,c("LocalIdNumber","BruNumber")]

#update the LocalIdNumber of one sample was does not match with the pheno file 
BRUID_localID$LocalIdNumber <- as.character(BRUID_localID$LocalIdNumber)
BRUID_localID$LocalIdNumber[BRUID_localID$LocalIdNumber == 'BELL-508 BIS'] <- "BELL-508"

#Add BRU IDs to pheno table
ACM_pheno_BRUID<-merge(BRUID_localID, ACM_pheno, by.x = "LocalIdNumber", by.y = "SAMPLES", all = TRUE) %>%
  tbl_df

#remove filtered data  
ACM_geno <- ACM_geno[(ACM_geno$Include  == "Yes"), ]

#remove irrelevant columns 
ACM_geno <-ACM_geno[,c("GENE","BRUID")]

ACM <- merge(ACM_geno, ACM_pheno_BRUID, by.x = "BRUID", by.y = "BruNumber", all = TRUE) %>%
  tbl_df

#replace na values in GENE column 
ACM$GENE <- as.character(ACM$GENE)
ACM$GENE[is.na(ACM$GENE)] <- "genotype_negative"

dim(ACM)

```



## data summary table 
```{r summarise acm phenotype by genotype}

continuousVariable_summary <- function(x){
  c<-paste(round(mean(x,na.rm=T), digits=2)," \u00b1 ", round(sd(x,na.rm=T)), sep="")
return(c)
}

binaryVariable_summary <- function(x,y){
  b<-paste(round(sum(x,na.rm=T))," \u0028",round(((sum(x,na.rm=T)/y) * 100), digits=1),"\u0029", sep="")
return(b)
}


ACM %>%
  #exclude samples with other_dcm_mutations, unless they are TTN pos
  filter(GENE=="TTN" | GENE=="genotype_negative") %>% 
group_by(GENE) %>%
  summarise(
    total=n(),
    Gr_alcohol=continuousVariable_summary(Gr_alcohol),
    AGE_AT_INITIAL_CLINICAL_ASSESSMENT=continuousVariable_summary(AGE_AT_INITIAL_CLINICAL_ASSESSMENT),
    INITIAL_EJECTION_FRACTION=continuousVariable_summary(INITIAL_EJECTION_FRACTION),
    FINAL_EJECTION_FRACTION=continuousVariable_summary(FINAL_EJECTION_FRACTION),
    DIASTOLIC_DIAMETER=continuousVariable_summary(DIASTOLIC_DIAMETER),
    DIASTOLIC_DIAMETER_FINAL=continuousVariable_summary(DIASTOLIC_DIAMETER_FINAL),
    SYSTOLIC_DIAMETER=continuousVariable_summary(SYSTOLIC_DIAMETER),
    FibrilaAuricular=binaryVariable_summary(FibrilaAuricular,n()),
    FAMILY_HISTORY_OF_CARDIOMYOPATHY=binaryVariable_summary(FAMILY_HISTORY_OF_CARDIOMYOPATHY,n()),
    FAMILY_HISTORY_OF_SUDDEN_CARDIAC_DEATH=binaryVariable_summary(FAMILY_HISTORY_OF_SUDDEN_CARDIAC_DEATH,n()),
    DEATH=binaryVariable_summary(DEATH,n()),
    SITUATION_INITIAL_EVALUATION=binaryVariable_summary(SITUATION_INITIAL_EVALUATION,n()),
    RECUPERA_FEVI=binaryVariable_summary(RECUPERA_FEVI,n()),
    CURRENT_DRINKER=binaryVariable_summary(CURRENT_DRINKER,n()),
    CRT=binaryVariable_summary(CRT,n()),
    QRS_gt_120=binaryVariable_summary(QRS_gt_120,n()),
    ICD=binaryVariable_summary(ICD,n()),
    TRANSPLANT=binaryVariable_summary(TRANSPLANT,n()),
    SMOKING=binaryVariable_summary(SMOKING,n()),
    RHYTHM=binaryVariable_summary(RHYTHM,n()),
    HYPERTENSION=binaryVariable_summary(HYPERTENSION,n()),
    DYSLIPIDEMIA=binaryVariable_summary(DYSLIPIDEMIA,n()),
    DIABETES_MELLITUS=binaryVariable_summary(DIABETES_MELLITUS,n()),
    COPD=binaryVariable_summary(COPD,n())
    ) %>%
  t %>% #transposes if you like that way...
  pander
```

I had to do `na.rm=T` here, because there was some missing data. Need to check if this appropriate.

## STATS Wilcoxon rank sum test 
```{r stats, include=FALSE}



ACM %>%
  filter(GENE=="TTN" | GENE=="genotype_negative") %>%
  #with(.,wilcox.test(INITIAL_EJECTION_FRACTION ~ GENE))
  with(.,chisq.test(x=RHYTHM,y=GENE))
```

```{r}
ACM %>%
  filter(GENE=="TTN" | GENE=="genotype_negative") %>%
  summarise(
    FibrilaAuricular=with(., chisq.test(x=FibrilaAuricular,y=GENE)$p.val),
    NYHA_CLASS=with(., chisq.test(x=NYHA_CLASS,y=GENE)$p.val),
    FAMILY_HISTORY_OF_CARDIOMYOPATHY=with(., chisq.test(x=FAMILY_HISTORY_OF_CARDIOMYOPATHY,y=GENE)$p.val),
    FAMILY_HISTORY_OF_SUDDEN_CARDIAC_DEATH=with(., chisq.test(x=FAMILY_HISTORY_OF_SUDDEN_CARDIAC_DEATH,y=GENE)$p.val),
    DEATH=with(., chisq.test(x=DEATH,y=GENE)$p.val),
    SITUATION_INITIAL_EVALUATION=with(., chisq.test(x=SITUATION_INITIAL_EVALUATION,y=GENE)$p.val),
    RECUPERA_FEVI=with(., chisq.test(x=RECUPERA_FEVI,y=GENE)$p.val),
    CURRENT_DRINKER=with(., chisq.test(x=CURRENT_DRINKER,y=GENE)$p.val),
    INITIAL_EJECTION_FRACTION=with(.,wilcox.test(INITIAL_EJECTION_FRACTION ~ GENE)$p.val),
    DIASTOLIC_DIAMETER=with(.,wilcox.test(DIASTOLIC_DIAMETER ~ GENE)$p.val),
    Gr_alcohol=with(.,wilcox.test(Gr_alcohol ~ GENE)$p.val),
    SYSTOLIC_DIAMETER=with(.,wilcox.test(SYSTOLIC_DIAMETER ~ GENE)$p.val),
    AGE_AT_INITIAL_CLINICAL_ASSESSMENT=with(.,wilcox.test(AGE_AT_INITIAL_CLINICAL_ASSESSMENT ~ GENE)$p.val)
  )%>%
  t %>% #transposes if you like that way...
  pander
  
```



Actually - looking at the output of the t.test, you could just get the means of the two group from there.  Or use the summary method above. Using wilcox.test as data is not normally distributed. This does not give mean and std dev

